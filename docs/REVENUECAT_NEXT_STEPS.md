# RevenueCat 次のステップ - 推奨進め方

## 概要

現在の進捗状況と、今後の作業の推奨進め方をまとめたドキュメントです。

**作成日**: 2025年1月29日  
**バージョン**: 1.0

---

## 現在の進捗状況

✅ **完了済み**:
- RevenueCatテストストアでの設定とテスト
- バックエンドAPIとの疎通確認
- Expo Go環境でのモック購入処理テスト

---

## 残作業と推奨進め方

### フェーズ1: RevenueCat Android/iOS APIキー作成とテスト

#### 1.1 RevenueCat Android/iOS APIキーの作成

**目的**: プラットフォーム固有のAPIキーを取得し、実際のストアAPIとの統合準備

**手順**:

1. **RevenueCatダッシュボードでプラットフォームを追加**
   - 左メニュー → 「**Apps & providers**」を選択
   - 「**Add app**」または「**Add platform**」をクリック
   - **iOS**: App Store Connectと連携
   - **Android**: Google Play Consoleと連携
   - アプリの情報を入力（Bundle ID / Package Nameなど）
   - ストアの認証情報を設定（App Store Connect API Key / Google Play Service Account）

2. **APIキーの取得**
   - 左メニュー → 「**API keys**」を選択
   - 「**Public API Keys**」セクションから取得
   - **iOS用**: `appl_xxxxxxxxxxxxxxxxxxxxx` 形式
   - **Android用**: `goog_xxxxxxxxxxxxxxxxxxxxx` 形式

3. **環境変数に設定**
   ```bash
   # .env ファイルに追加
   EXPO_PUBLIC_REVENUECAT_IOS_API_KEY=appl_xxxxxxxxxxxxxxxxxxxxx
   EXPO_PUBLIC_REVENUECAT_ANDROID_API_KEY=goog_xxxxxxxxxxxxxxxxxxxxx
   ```

**注意**: この時点では、ストア側での商品登録はまだ不要です。RevenueCatでプラットフォームを追加するだけで、APIキーが生成されます。

#### 1.2 プラットフォーム固有APIキーでのテスト

**何が確認できるか**:

✅ **確認できること**:
- RevenueCat SDKの初期化が正常に動作するか
- プラットフォーム固有のAPIキーでRevenueCatに接続できるか
- RevenueCatダッシュボードでプラットフォームが正しく設定されているか

❌ **まだ確認できないこと**:
- 実際のストアAPIとの統合（ストア側で商品登録が必要）
- 実際の購入処理（ストア側で商品登録が必要）
- レシート検証（ストア側で商品登録が必要）

**Expo Goでどこまで確認できるか**:

- ✅ RevenueCat SDKの初期化処理の呼び出し
- ✅ エラーハンドリングのテスト
- ✅ バックエンドAPIとの疎通確認
- ❌ 実際のストアAPIとの統合（ネイティブモジュールが必要）
- ❌ 実際の購入処理（ネイティブモジュールが必要）

**推奨テスト方法**:

1. **Expo Go環境**:
   - 環境変数をプラットフォーム固有のAPIキーに切り替え
   - アプリを再起動
   - RevenueCatの初期化が試行されることを確認（エラーが発生する可能性があるが、エラーハンドリングのテストが可能）

2. **開発ビルド環境**（推奨）:
   - 開発ビルドを作成
   - プラットフォーム固有のAPIキーで初期化を試行
   - ストア側で商品登録が完了していないため、オファリング取得は失敗する可能性がある
   - エラーハンドリングのテストが可能

**確認できることの増加**:

- テストストア用APIキーからプラットフォーム固有APIキーに切り替えることで、RevenueCatダッシュボードでプラットフォームが正しく設定されているか確認できます
- ただし、ストア側で商品登録が完了していないため、実際の購入処理はまだテストできません

---

### フェーズ2: ストア側での商品登録

#### 2.1 Android（Google Play Console）での商品登録

**手順**: `docs/STORE_SETUP_GUIDE.md`を参照

**必要な情報**:
- Google Play Consoleアカウント
- 開発者登録（$25の一度限りの登録料）
- アプリがGoogle Play Consoleに登録されていること

**登録する商品**:
- `morizo_pro_monthly` - Morizo PRO（月額）
- `morizo_ultimate_monthly` - Morizo ULTIMATE（月額）

**所要時間**: 商品登録後、承認まで数時間〜数日かかる場合があります

#### 2.2 iOS（App Store Connect）での商品登録

**手順**: `docs/STORE_SETUP_GUIDE.md`を参照

**必要な情報**:
- App Store Connectアカウント
- Apple Developer Programへの登録（年間$99）
- アプリがApp Store Connectに登録されていること

**登録する商品**:
- `morizo_pro_monthly` - Morizo PRO（月額）
- `morizo_ultimate_monthly` - Morizo ULTIMATE（月額）

**所要時間**: 商品登録後、承認まで数時間〜数日かかる場合があります

**注意**: iOSの商品登録は、App Store Connectでアプリが「準備完了」状態になっている必要があります。

---

### フェーズ3: ストア登録後のテスト

#### 3.1 RevenueCatでの商品連携

**手順**:

1. **RevenueCatダッシュボードで商品を連携**
   - 左メニュー → 「**Product catalog**」を選択
   - 既存の商品（テストストアで作成した商品）を選択
   - ストアで登録した商品IDと連携
   - または、新しい商品を作成してストアの商品IDと連携

2. **オファリングに商品を追加**
   - 左メニュー → 「**Offerings**」を選択
   - 既存のオファリング（`default`）を選択
   - ストアで登録した商品をパッケージに追加

#### 3.2 サンドボックステスト

**Androidでのテスト**:

✅ **確認できること**:
- 実際のGoogle Play Billing APIとの統合
- サンドボックス環境での購入処理
- レシート検証の動作
- バックエンドAPIとの同期

**テスト方法**:
1. Google Play Consoleでテストアカウントを設定
2. 開発ビルドを作成（Android）
3. テストアカウントでログイン
4. サンドボックス環境で購入テストを実行

**注意**: Androidのサンドボックステストは、実機またはエミュレータで実行する必要があります。

**iOSでのテスト**:

✅ **確認できること**:
- 実際のApp Store APIとの統合
- サンドボックス環境での購入処理
- レシート検証の動作
- バックエンドAPIとの同期

**テスト方法**:
1. App Store Connectでサンドボックステスターを設定
2. 開発ビルドを作成（iOS）
3. サンドボックステスターでログイン
4. サンドボックス環境で購入テストを実行

**注意**: iOSのサンドボックステストは、実機（iPhone/iPad）で実行する必要があります。シミュレータでは動作しません。

#### 3.3 Androidだけしかテストできないか？

**答え**: いいえ、iOSでもテストできます。

**制限事項**:
- **Android**: 実機またはエミュレータでテスト可能
- **iOS**: 実機（iPhone/iPad）でのみテスト可能（シミュレータでは動作しない）

**推奨アプローチ**:
1. **まずAndroidでテスト**（エミュレータで簡単にテスト可能）
2. **次にiOSでテスト**（実機が必要だが、同様のテストが可能）

**両方のプラットフォームでテストすべき理由**:
- プラットフォームごとにレシート検証の方法が異なる
- エラーハンドリングがプラットフォームごとに異なる可能性がある
- 実際のユーザー体験を確認するため

---

### フェーズ4: 本番環境リリース

#### 4.1 本番環境への移行準備

**確認事項**:
- [ ] サンドボックステストが完了している
- [ ] バックエンドAPIのレシート検証が正常に動作している
- [ ] エラーハンドリングが適切に実装されている
- [ ] ログ出力が適切に設定されている

#### 4.2 本番環境へのデプロイ

**手順**:
1. プラットフォーム固有のAPIキーを使用（既に設定済み）
2. ストアで設定した実際の製品をオファリングに追加（既に設定済み）
3. 本番環境のビルドを作成
4. ストアに提出

---

## 推奨進め方（まとめ）

### ステップ1: RevenueCat Android/iOS APIキー作成（優先度: 高）

**所要時間**: 30分〜1時間

**作業内容**:
1. RevenueCatダッシュボードでプラットフォーム（iOS/Android）を追加
2. プラットフォーム固有のAPIキーを取得
3. 環境変数に設定
4. 開発ビルドで初期化テスト

**確認できること**:
- RevenueCat SDKの初期化が正常に動作するか
- プラットフォーム固有のAPIキーでRevenueCatに接続できるか

**Expo Goでの確認**:
- エラーハンドリングのテストのみ可能
- 実際のストアAPIとの統合は確認できない

### ステップ2: Androidストアでの商品登録（優先度: 高）

**所要時間**: 1〜2時間（承認待ち時間を除く）

**作業内容**:
1. Google Play Consoleで商品を登録
2. 商品の承認を待つ（数時間〜数日）
3. RevenueCatで商品を連携

**確認できること**:
- ストア側での商品登録が正常に完了しているか
- RevenueCatとストアの連携が正常に動作しているか

**推奨理由**:
- Androidはエミュレータで簡単にテストできる
- iOSよりも承認プロセスが早い場合がある

### ステップ3: Androidサンドボックステスト（優先度: 高）

**所要時間**: 1〜2時間

**作業内容**:
1. 開発ビルドを作成（Android）
2. テストアカウントでログイン
3. サンドボックス環境で購入テスト

**確認できること**:
- 実際のGoogle Play Billing APIとの統合
- サンドボックス環境での購入処理
- レシート検証の動作
- バックエンドAPIとの同期

**Expo Goでの確認**:
- サンドボックステストは開発ビルドが必要（Expo Goでは不可）

### ステップ4: iOSストアでの商品登録（優先度: 中）

**所要時間**: 1〜2時間（承認待ち時間を除く）

**作業内容**:
1. App Store Connectで商品を登録
2. 商品の承認を待つ（数時間〜数日）
3. RevenueCatで商品を連携

**確認できること**:
- ストア側での商品登録が正常に完了しているか
- RevenueCatとストアの連携が正常に動作しているか

**注意**: iOSの商品登録は、App Store Connectでアプリが「準備完了」状態になっている必要があります。

### ステップ5: iOSサンドボックステスト（優先度: 中）

**所要時間**: 1〜2時間

**作業内容**:
1. 開発ビルドを作成（iOS）
2. 実機（iPhone/iPad）にインストール
3. サンドボックステスターでログイン
4. サンドボックス環境で購入テスト

**確認できること**:
- 実際のApp Store APIとの統合
- サンドボックス環境での購入処理
- レシート検証の動作
- バックエンドAPIとの同期

**注意**: iOSのサンドボックステストは、実機（iPhone/iPad）で実行する必要があります。シミュレータでは動作しません。

### ステップ6: 本番環境リリース（優先度: 低）

**所要時間**: 数時間〜数日（ストアの審査時間を含む）

**作業内容**:
1. 本番環境のビルドを作成
2. ストアに提出
3. 審査を待つ
4. リリース

---

## 各フェーズでの確認事項まとめ

### フェーズ1: RevenueCat Android/iOS APIキー作成後

| 確認項目 | Expo Go | 開発ビルド |
|---------|---------|-----------|
| RevenueCat SDK初期化 | エラーハンドリングのみ | ✅ 可能 |
| プラットフォーム固有APIキー接続 | エラーハンドリングのみ | ✅ 可能 |
| ストアAPI統合 | ❌ 不可 | ❌ 不可（商品登録が必要） |
| 実際の購入処理 | ❌ 不可 | ❌ 不可（商品登録が必要） |

### フェーズ2: ストア商品登録後

| 確認項目 | Expo Go | 開発ビルド |
|---------|---------|-----------|
| RevenueCat SDK初期化 | エラーハンドリングのみ | ✅ 可能 |
| プラットフォーム固有APIキー接続 | エラーハンドリングのみ | ✅ 可能 |
| ストアAPI統合 | ❌ 不可 | ✅ 可能（サンドボックス） |
| 実際の購入処理 | ❌ 不可 | ✅ 可能（サンドボックス） |

### フェーズ3: サンドボックステスト後

| 確認項目 | Android | iOS |
|---------|---------|-----|
| サンドボックス購入 | ✅ 可能（実機/エミュレータ） | ✅ 可能（実機のみ） |
| レシート検証 | ✅ 可能 | ✅ 可能 |
| バックエンド同期 | ✅ 可能 | ✅ 可能 |

---

## よくある質問

### Q1: Expo Goでどこまで確認できるか？

**A**: Expo Go環境では、以下のことが確認できます：
- ✅ UIのプレビュー
- ✅ エラーハンドリングのテスト
- ✅ バックエンドAPIとの疎通確認
- ❌ 実際のストアAPIとの統合（ネイティブモジュールが必要）
- ❌ 実際の購入処理（ネイティブモジュールが必要）

**推奨**: 初期のUIテストはExpo Goで行い、実際の購入フローのテストは開発ビルドで行うことを推奨します。

### Q2: Androidだけしかテストできないか？

**A**: いいえ、iOSでもテストできます。ただし、以下の制限があります：
- **Android**: 実機またはエミュレータでテスト可能
- **iOS**: 実機（iPhone/iPad）でのみテスト可能（シミュレータでは動作しない）

**推奨**: まずAndroidでテストし、次にiOSでテストすることを推奨します。

### Q3: プラットフォーム固有APIキー作成後、何が確認できるか？

**A**: プラットフォーム固有APIキー作成後、以下のことが確認できます：
- ✅ RevenueCat SDKの初期化が正常に動作するか
- ✅ プラットフォーム固有のAPIキーでRevenueCatに接続できるか
- ✅ RevenueCatダッシュボードでプラットフォームが正しく設定されているか

**まだ確認できないこと**:
- ❌ 実際のストアAPIとの統合（ストア側で商品登録が必要）
- ❌ 実際の購入処理（ストア側で商品登録が必要）

### Q4: ストア商品登録後、確認できることは増えるか？

**A**: はい、以下のことが確認できるようになります：
- ✅ 実際のストアAPIとの統合
- ✅ サンドボックス環境での購入処理
- ✅ レシート検証の動作
- ✅ バックエンドAPIとの同期

**注意**: サンドボックステストは開発ビルドが必要です（Expo Goでは不可）。

---

## チェックリスト

### フェーズ1: RevenueCat Android/iOS APIキー作成
- [ ] RevenueCatダッシュボードでプラットフォーム（iOS/Android）を追加
- [ ] プラットフォーム固有のAPIキーを取得
- [ ] 環境変数に設定
- [ ] 開発ビルドで初期化テスト

### フェーズ2: ストア商品登録
- [ ] Google Play Consoleで商品を登録
- [ ] App Store Connectで商品を登録
- [ ] RevenueCatで商品を連携
- [ ] オファリングに商品を追加

### フェーズ3: サンドボックステスト
- [ ] Androidサンドボックステスト
- [ ] iOSサンドボックステスト
- [ ] レシート検証の確認
- [ ] バックエンドAPI同期の確認

### フェーズ4: 本番環境リリース
- [ ] 本番環境のビルドを作成
- [ ] ストアに提出
- [ ] 審査を待つ
- [ ] リリース

---

**最終更新**: 2025年1月29日  
**作成者**: AIエージェント協働チーム

