# 開発ビルド完全ガイド

## 概要

このドキュメントは、開発ビルドの使い方、開発ビルドとプロダクションビルドの違い、よくある誤解を解消するための完全ガイドです。

**作成日**: 2025年1月29日  
**バージョン**: 2.0

---

## 📋 目次

1. [クイックスタート](#クイックスタート) - **普段はここだけ見ればOK**
2. [開発ビルド vs プロダクションビルド](#開発ビルド-vs-プロダクションビルド)
3. [よくある誤解と正しい理解](#よくある誤解と正しい理解)
4. [トラブルシューティング](#トラブルシューティング)

---

# クイックスタート

**普段はここだけ見ればOKです。理解を深めたい時は、下のセクションを読み進めてください。**

## 位置づけの理解

開発ビルドは、以下の3つの選択肢の中間的な位置づけです：

```
Expo Go  ←  開発ビルド  →  ストア提出用ビルド
(簡単)      (中間)          (本番)
```

| 項目 | Expo Go | 開発ビルド | ストア提出用 |
|------|---------|-----------|------------|
| **ネイティブモジュール** | ❌ 動作しない | ✅ 動作する | ✅ 動作する |
| **ホットリロード** | ✅ 可能 | ✅ 可能 | ❌ 不可能 |
| **ストア提出** | ❌ 不可 | ❌ 不可 | ✅ 可能 |
| **RevenueCatテスト** | ❌ 不可 | ✅ テストストアで可能 | ⚠️ 本番環境のみ |

## 前提条件

- ✅ EAS CLIがインストールされている（`eas --version`で確認）
- ✅ EASにログインしている（`eas whoami`で確認）
- ✅ `eas.json`が設定されている
- ✅ `expo-doctor`でエラーがない

## ステップ1: 開発ビルドの作成（初回のみ）

```bash
cd /app/Morizo-mobile
eas build --profile development --platform android
```

**ビルド時間**: 通常10-20分  
**ビルド完了後**: APKファイルをダウンロード

## ステップ2: 開発ビルドを実機にインストール

1. **APKファイルを実機に転送**（USB、クラウド、直接ダウンロードなど）
2. **実機でAPKファイルをタップしてインストール**
3. **「不明なソースからのアプリ」を許可**（必要に応じて）

## ステップ3: 開発サーバーの起動

```bash
npm start
```

または

```bash
npx expo start
```

**注意**: `expo start`コマンドが直接使えない場合は、`npm start`または`npx expo start`を使用してください。

**実行結果**: QRコードとURLが表示される

## ステップ4: 開発ビルドアプリで接続

1. **実機で開発ビルドアプリを起動**（ステップ2でインストールしたアプリ）
2. **QRコードをスキャン**（開発ビルドアプリ内で）
   - **Docker環境の場合**: QRコードのIPアドレスがコンテナのIPになっている可能性があります。その場合は、URLを直接入力してください（下記参照）
3. **自動的に開発サーバーに接続**

**Docker環境での注意**:
- Dockerコンテナ内で開発している場合、QRコードに表示されるIPアドレスがコンテナのIPアドレス（例: `192.168.1.13`）になっていることがあります
- 実機からは直接コンテナのIPにアクセスできない場合があるため、**URLを直接入力**する方法を使用してください
- 例: `exp://192.168.1.13:8081` または `http://192.168.1.13:8081`

## ステップ5: 開発開始（ホットリロード）

1. **コードを変更して保存**
2. **数秒以内にアプリに自動反映**（再ビルド不要）

## 簡単な流れ（図解）

```
1. eas build --profile development --platform android
   ↓ (10-20分)
2. APKをダウンロードして実機にインストール
   ↓
3. expo start (開発サーバー起動)
   ↓
4. 開発ビルドアプリでQRコードをスキャン
   ↓
5. ホットリロードで開発開始！
```

---

# 開発ビルド vs プロダクションビルド

## ビルドプロファイルの違い

### 開発ビルド（`--profile development`）

**設定** (`eas.json`):
```json
{
  "development": {
    "developmentClient": true,
    "distribution": "internal"
  }
}
```

**特徴**:
- **Development Client（開発クライアント）**が組み込まれたビルド
- ネイティブモジュール（`react-native-purchases`など）が動作する
- `expo start`で開発サーバーに接続してホットリロードが可能
- 内部配布用（ストア提出不可）
- **生成されるファイル**: Androidは**APK**、iOSは**IPA**（AAB形式は生成されない）

### プロダクションビルド（`--profile production`）

**設定** (`eas.json`):
```json
{
  "production": {
    "distribution": "store",
    "autoIncrement": true
  }
}
```

**特徴**:
- 本番環境用の最適化されたビルド
- ストア提出用（Google Play Store / App Store Connect）
- バージョン番号が自動インクリメントされる
- 開発サーバーへの接続機能なし

## 主な違いの比較表

| 項目 | 開発ビルド | プロダクションビルド |
|------|-----------|-------------------|
| **Development Client** | ✅ 組み込まれている | ❌ 組み込まれていない |
| **ネイティブモジュール** | ✅ 動作する | ✅ 動作する |
| **ホットリロード** | ✅ 可能（`expo start`で接続） | ❌ 不可能 |
| **ストア提出** | ❌ 不可 | ✅ 可能 |
| **配布方法** | 内部配布のみ | ストア配布 |
| **バージョン管理** | 手動 | 自動インクリメント |
| **最適化** | 開発用（デバッグ情報あり） | 本番用（最適化済み） |
| **RevenueCatテスト** | ✅ テストストアでテスト可能 | ⚠️ 本番環境のみ |
| **Android形式** | APK | AAB（デフォルト）またはAPK |
| **iOS形式** | IPA | IPA |

## 開発ビルドのメリット・デメリット

### ✅ メリット

1. **ネイティブモジュールが動作する**
   - `react-native-purchases`（RevenueCat）などのネイティブモジュールが正常に動作
   - Expo Goでは動作しない機能をテスト可能

2. **ホットリロードが可能**
   - `expo start`で開発サーバーに接続
   - コード変更が即座に反映される（再ビルド不要）
   - 開発効率が大幅に向上

3. **テスト環境での動作確認**
   - RevenueCatのテストストアでの購入テストが可能
   - バックエンドAPIとの統合テストが可能
   - 実際の購入フローをテスト可能（課金なし）

4. **デバッグ情報が豊富**
   - 開発用のログやエラー情報が詳細
   - 問題の特定が容易

5. **ビルド回数の節約**
   - コード変更時は再ビルド不要（ホットリロードで対応）
   - EAS Buildの月間制限を節約できる

### ❌ デメリット

1. **ストア提出不可**
   - Google Play Store / App Store Connectに提出できない
   - 本番環境へのリリースには使用できない

2. **初回ビルドが必要**
   - 最初に開発ビルドを作成する必要がある
   - ビルド時間がかかる（通常10-20分）

3. **ファイルサイズが大きい**
   - Development Clientが組み込まれているため、ファイルサイズが大きい
   - 本番ビルドより10-20MB程度大きい場合がある

4. **セキュリティ設定が緩い**
   - 開発用の設定のため、本番環境よりセキュリティが緩い
   - デバッグ情報が含まれる

## プロダクションビルドのメリット・デメリット

### ✅ メリット

1. **ストア提出可能**
   - Google Play Store / App Store Connectに直接提出できる
   - 本番環境へのリリースに使用可能

2. **最適化されている**
   - 本番環境用に最適化されている
   - ファイルサイズが小さい
   - パフォーマンスが良い

3. **バージョン管理が自動**
   - `autoIncrement: true`により、バージョン番号が自動でインクリメントされる
   - 手動でのバージョン管理が不要

4. **セキュリティが高い**
   - 本番環境用のセキュリティ設定
   - デバッグ情報が含まれない

### ❌ デメリット

1. **ホットリロード不可**
   - コード変更時は再ビルドが必要
   - 開発効率が低下する可能性

2. **テストが制限される**
   - RevenueCatのテストストアでのテストは不可（本番環境のみ）
   - 実際の課金が発生する可能性がある

3. **ビルド回数の消費**
   - コード変更のたびに再ビルドが必要
   - EAS Buildの月間制限を消費しやすい

4. **開発中のテストが困難**
   - ネイティブモジュールの動作確認が困難
   - デバッグ情報が少ない

## 使い分けの指針

### 開発ビルドを使うべき場合

1. **開発・テスト段階**
   - 機能開発中
   - RevenueCatのテストストアでのテスト
   - バックエンドAPIとの統合テスト
   - ネイティブモジュールの動作確認

2. **頻繁なコード変更**
   - ホットリロードで効率的に開発したい場合
   - ビルド回数を節約したい場合

3. **デバッグが必要な場合**
   - 詳細なログやエラー情報が必要
   - 問題の特定と修正を繰り返す場合

### プロダクションビルドを使うべき場合

1. **ストア提出前**
   - Google Play Store / App Store Connectに提出する前
   - 本番環境へのリリース前の最終確認

2. **本番環境でのテスト**
   - 実際のストア環境でのテスト
   - エンドユーザー向けのテスト

3. **リリース準備**
   - ストアに提出する最終ビルド
   - 本番環境へのデプロイ

## RevenueCatテストストアでのテストについて

### 開発ビルドが必要な理由

**RevenueCatのテストストアでのテストには、開発ビルドが必須です。**

理由：
1. **ネイティブモジュールの動作**
   - `react-native-purchases`はネイティブモジュールのため、Expo Goでは動作しない
   - 開発ビルドでは正常に動作する

2. **実際の購入フローのテスト**
   - テストストアでの購入処理をテスト可能
   - バックエンドAPIとの同期をテスト可能

3. **エンタイトルメントの確認**
   - 購入後のエンタイトルメント付与を確認可能
   - RevenueCatダッシュボードでの購入データ確認が可能

### プロダクションビルドではできないこと

- ❌ RevenueCatのテストストアでのテスト（本番環境のみ）
- ❌ 実際の課金なしでの購入テスト
- ❌ 開発中の頻繁なテスト

## `expo start`とは？

### 概要

`expo start`は、**Expo開発サーバーを起動するコマンド**です。開発中のアプリにJavaScriptコードを配信し、ホットリロード（コード変更の即座反映）を可能にします。

### 開発サーバーとは？

開発サーバーは、以下の機能を提供します：

1. **JavaScriptバンドルの配信**: アプリのJavaScriptコードを配信
2. **ホットリロード**: コード変更を即座にアプリに反映
3. **Fast Refresh**: Reactコンポーネントの状態を保持しながら更新
4. **ログ表示**: アプリのログやエラーをターミナルに表示

### 使い方

#### 1. 開発サーバーの起動

```bash
# プロジェクトディレクトリで実行
cd /app/Morizo-mobile
expo start
```

**実行結果**:
```
› Metro waiting on exp://192.168.1.12:8081
› Scan the QR code above with Expo Go (Android) or the Camera app (iOS)

› Press a │ open Android
│ i │ open iOS simulator
│ w │ open web

› Press r │ reload app
› Press m │ toggle menu
```

#### 2. 開発ビルドアプリで接続

**方法A: QRコードをスキャン（通常環境）**
1. 開発ビルドアプリを起動
2. ターミナルに表示されるQRコードをスキャン
3. 自動的に開発サーバーに接続

**方法B: URLを直接入力（推奨、特にDocker環境）**
1. 開発ビルドアプリを起動
2. ターミナルに表示されるURL（例: `exp://192.168.1.12:8081`または`http://192.168.1.13:8081`）を入力
3. 開発サーバーに接続

**Docker環境での注意**:
- Dockerコンテナ内で開発している場合、QRコードのIPアドレスがコンテナのIPアドレスになっていることがあります
- 実機から直接コンテナのIPにアクセスできない場合は、**URLを直接入力する方法**を使用してください
- 例: `exp://192.168.1.13:8081` または `http://192.168.1.13:8081`

#### 3. ホットリロードの動作

接続後、以下のように動作します：

1. **コードを変更**（例: `SubscriptionScreen.tsx`を編集）
2. **ファイルを保存**
3. **自動的にアプリに反映**（数秒以内）
4. **再ビルド不要**（JavaScriptコードのみ更新）

## 推奨ワークフロー

### ステップ1: 開発ビルドで開発・テスト（現在の段階）

```bash
# 1. 開発ビルドの作成（初回のみ、APK/IPA形式で生成）
eas build --profile development --platform android

# 2. 開発ビルドを実機にインストール
# - ダウンロードしたAPKファイルを実機に転送してインストール
# - または、EAS Buildのダウンロードリンクから直接インストール

# 3. 開発サーバーの起動
expo start

# 4. 開発ビルドアプリで接続
# - QRコードをスキャン、またはURLを入力
# - 開発サーバーに接続

# 5. 開発開始
# - コードを変更して保存
# - 自動的にアプリに反映（ホットリロード）
# - RevenueCatのテストストアで購入テスト
# - バックエンドAPIとの統合テスト
```

**メリット**:
- ✅ 開発効率が高い（ホットリロード）
- ✅ RevenueCatのテストストアでテスト可能
- ✅ ビルド回数を節約（コード変更時は再ビルド不要）

### ステップ2: プロダクションビルドで最終確認

```bash
# プロダクションビルドの作成
eas build --platform android --profile production

# ストア提出前の最終確認
# - 本番環境での動作確認
# - パフォーマンステスト
```

**メリット**:
- ✅ ストア提出可能
- ✅ 本番環境での動作確認

### ステップ3: ストア提出

```bash
# ストアへの提出
eas submit --platform android
```

---

# よくある誤解と正しい理解

## ❌ 誤解1: 開発ビルドはローカルでビルドする

**誤解**: 開発ビルドはローカル環境でビルドするため、ビルド回数がカウントされない。

**正しい理解**: 
- **開発ビルドもEAS Build（クラウドビルド）で作成します**
- **ビルド回数はカウントされます**
- ローカルでビルドするのではなく、Expoのクラウドサーバーでビルドします

## ❌ 誤解2: ローカルでAPKを作って、expo startで実機へ送る

**誤解**: ローカルでAPKを作成し、`expo start`でExpo Goのように実機へ送る。

**正しい理解**:
1. **EAS Build（クラウド）でAPKを作成**（ビルド回数カウント）
2. **APKをダウンロードして実機にインストール**（通常のアプリインストール）
3. **`expo start`で開発サーバーを起動**（JavaScriptコードを配信）
4. **開発ビルドアプリで開発サーバーに接続**（QRコードまたはURL）

## ❌ 誤解3: Expo GoでQRコードを読み取る

**誤解**: Expo GoアプリでQRコードを読み取って接続する。

**正しい理解**:
- **Expo Goは使用しません**
- **開発ビルドアプリ（Development Client）でQRコードを読み取ります**
- 開発ビルドアプリは、EAS Buildで作成したAPK/IPAをインストールしたアプリです

## 正しい開発ビルドの流れ（詳細）

### ステップ1: 開発ビルドの作成（初回のみ）

```bash
# EAS Build（クラウドビルド）で開発ビルドを作成
eas build --profile development --platform android
```

**重要なポイント**:
- ✅ **EAS Build（クラウド）でビルド**（ローカルではない）
- ✅ **ビルド回数はカウントされる**
- ✅ **APK/IPA形式で生成される**（AAB形式ではない）
- ⏱️ **ビルド時間**: 通常10-20分

**ビルド完了後**:
- EAS DashboardからAPK/IPAをダウンロード
- または、ビルド完了時にダウンロードリンクが提供される

### ステップ2: 開発ビルドを実機にインストール

**Androidの場合**:
1. ダウンロードしたAPKファイルを実機に転送
2. 実機でAPKファイルをタップしてインストール
3. 「不明なソースからのアプリ」を許可（必要に応じて）

**iOSの場合**:
1. ダウンロードしたIPAファイルを実機に転送
2. XcodeやApple Configuratorでインストール
3. 実機の設定で開発者アプリを信頼

**重要なポイント**:
- ✅ **通常のアプリインストールと同じ**（Expo Goではない）
- ✅ **開発ビルドアプリが実機にインストールされる**
- ✅ **このアプリは「Development Client」が組み込まれている**

### ステップ3: 開発サーバーの起動

```bash
# プロジェクトディレクトリで実行
cd /app/Morizo-mobile
expo start
```

**実行結果**:
```
› Metro waiting on exp://192.168.1.12:8081
› Scan the QR code above with Expo Go (Android) or the Camera app (iOS)
```

**重要なポイント**:
- ✅ **開発サーバーが起動**（JavaScriptコードを配信）
- ✅ **QRコードとURLが表示される**
- ✅ **この時点では、まだアプリは接続していない**

### ステップ4: 開発ビルドアプリで接続

**方法A: QRコードをスキャン（推奨）**

1. **実機で開発ビルドアプリを起動**
   - ステップ2でインストールしたアプリを起動
   - Expo Goではない

2. **開発ビルドアプリでQRコードをスキャン**
   - 開発ビルドアプリには、QRコードスキャン機能が組み込まれている
   - カメラアプリで読み取るのではなく、開発ビルドアプリ内で読み取る

3. **自動的に開発サーバーに接続**
   - 接続後、JavaScriptコードがダウンロードされる
   - アプリが起動する

**方法B: URLを直接入力**

1. **実機で開発ビルドアプリを起動**
2. **URLを入力**（例: `exp://192.168.1.12:8081`）
3. **開発サーバーに接続**

**重要なポイント**:
- ✅ **Expo Goは使用しない**
- ✅ **開発ビルドアプリ（Development Client）を使用**
- ✅ **開発ビルドアプリ内でQRコードを読み取る**

### ステップ5: 開発開始（ホットリロード）

接続後、以下のように動作します：

1. **コードを変更**（例: `SubscriptionScreen.tsx`を編集）
2. **ファイルを保存**
3. **自動的にアプリに反映**（数秒以内）
4. **再ビルド不要**（JavaScriptコードのみ更新）

**重要なポイント**:
- ✅ **コード変更時は再ビルド不要**
- ✅ **ホットリロードで即座に反映**
- ✅ **ビルド回数を節約できる**

## 開発ビルド vs Expo Go

### Expo Go（従来の方法）

**特徴**:
- Expo公式アプリ（App Store / Google Playからインストール）
- ネイティブモジュールが動作しない（`react-native-purchases`など）
- QRコードをスキャンして接続
- 開発サーバーに接続してホットリロード可能

**制限**:
- ❌ ネイティブモジュールが動作しない
- ❌ RevenueCatのテストストアでテスト不可

### 開発ビルド（推奨方法）

**特徴**:
- EAS Buildで作成したカスタムアプリ（Development Client組み込み）
- ネイティブモジュールが動作する（`react-native-purchases`など）
- QRコードをスキャンして接続（開発ビルドアプリ内で）
- 開発サーバーに接続してホットリロード可能

**メリット**:
- ✅ ネイティブモジュールが動作する
- ✅ RevenueCatのテストストアでテスト可能

## ビルド回数について

### ビルド回数のカウント

**開発ビルドもビルド回数はカウントされます**。

| ビルドタイプ | ビルド回数カウント | 説明 |
|------------|----------------|------|
| **開発ビルド** | ✅ **カウントされる** | EAS Build（クラウド）でビルド |
| **プロダクションビルド** | ✅ **カウントされる** | EAS Build（クラウド）でビルド |
| **ローカルビルド** | ❌ カウントされない | ローカル環境でビルド（上級者向け） |

**重要なポイント**:
- 開発ビルドもEAS Build（クラウド）で作成するため、ビルド回数はカウントされます
- ただし、コード変更時は再ビルド不要（ホットリロードで対応）のため、結果的にビルド回数を節約できます

### ビルド回数の節約方法

**開発ビルドのメリット**:
- 初回のみビルド（通常10-20分）
- コード変更時は再ビルド不要（ホットリロードで対応）
- 結果的に、ビルド回数を大幅に節約できる

**プロダクションビルドの場合**:
- コード変更のたびに再ビルドが必要
- ビルド回数を消費しやすい

---

# トラブルシューティング

## 問題1: ビルドが失敗する

**確認事項**:
- EASにログインしているか（`eas whoami`）
- `eas.json`が正しく設定されているか
- `app.json`の設定が正しいか
- `expo-doctor`でエラーがないか

**対処法**:
```bash
# expo-doctorで確認
npx expo-doctor

# EASにログイン確認
eas whoami

# ビルドログを確認
# EAS DashboardのBuildsセクションから確認
```

## 問題2: 開発ビルドアプリが起動しない

**確認事項**:
- APKファイルが正しくインストールされているか
- 実機の設定で「不明なソースからのアプリ」が許可されているか

**対処法**:
1. アプリをアンインストールして再インストール
2. 実機の設定を確認

## 問題3: QRコードをスキャンできない

**確認事項**:
- 開発サーバーが起動しているか（`expo start`）
- 実機とPCが同じネットワークに接続されているか
- ファイアウォールがブロックしていないか

**対処法**:
1. URLを直接入力する方法を試す
2. ネットワーク接続を確認
3. ファイアウォール設定を確認

## 問題4: ホットリロードが動作しない

**確認事項**:
- 開発ビルドアプリが開発サーバーに接続されているか
- コード変更後にファイルを保存しているか

**対処法**:
1. アプリを再起動して接続し直す
2. 開発サーバーを再起動（Ctrl+Cで停止、`expo start`で再起動）

## 問題5: RevenueCatが動作しない

**確認事項**:
- 開発ビルドを使用しているか（Expo Goでは動作しない）
- 環境変数が正しく設定されているか
- RevenueCatの初期化が成功しているか

**対処法**:
1. 開発ビルドを使用していることを確認
2. `.env`ファイルの環境変数を確認
3. アプリのログでRevenueCatの初期化を確認

---

## よくある質問

### Q1: 開発ビルドとプロダクションビルド、どちらを使うべきですか？

**A**: 開発・テスト段階では**開発ビルド**、ストア提出前の最終確認とリリース時は**プロダクションビルド**を使用してください。

### Q2: 開発ビルドでもRevenueCatのテストストアでテストできますか？

**A**: はい、できます。開発ビルドでは、RevenueCatのテストストアでの購入テストが可能です。実際の課金は発生しません。

### Q3: プロダクションビルドでもRevenueCatのテストストアでテストできますか？

**A**: いいえ、できません。プロダクションビルドは本番環境用のため、RevenueCatのテストストアではなく、実際のストア環境でのテストになります。

### Q4: 開発ビルドからプロダクションビルドに切り替える必要がありますか？

**A**: ストア提出時には、必ずプロダクションビルドを使用してください。開発ビルドはストア提出不可です。

### Q5: 開発ビルドのファイルサイズが大きいのは問題ですか？

**A**: 開発・テスト段階では問題ありません。本番環境へのリリース時は、プロダクションビルドを使用するため、ファイルサイズは最適化されます。

### Q6: ビルド回数はカウントされますか？

**A**: はい、カウントされます。開発ビルドもEAS Build（クラウド）で作成するため、ビルド回数はカウントされます。ただし、コード変更時は再ビルド不要（ホットリロードで対応）のため、結果的にビルド回数を節約できます。

---

## まとめ

### 位置づけの再確認

```
Expo Go  ←  開発ビルド  →  ストア提出用ビルド
(簡単)      (中間)          (本番)
```

- **Expo Go**: 簡単だが、ネイティブモジュールが動作しない
- **開発ビルド**: ネイティブモジュールが動作し、ホットリロード可能
- **ストア提出用**: 本番環境用、ストア提出可能

### 正しい理解

1. **開発ビルドはEAS Build（クラウド）で作成**
   - ローカルでビルドするのではない
   - ビルド回数はカウントされる

2. **開発ビルドの流れ**:
   - EAS BuildでAPK/IPAを作成（クラウド）
   - APK/IPAを実機にインストール
   - `expo start`で開発サーバーを起動
   - 開発ビルドアプリで開発サーバーに接続

3. **QRコードの読み取り**:
   - Expo Goではなく、開発ビルドアプリ（Development Client）で読み取る
   - 開発ビルドアプリ内でQRコードをスキャン

### 推奨ワークフロー

1. **開発・テスト**: 開発ビルドを使用
2. **ストア提出前**: プロダクションビルドで最終確認
3. **リリース**: プロダクションビルドをストアに提出

---

**最終更新**: 2025年1月29日  
**バージョン**: 2.0  
**作成者**: AIエージェント協働チーム

